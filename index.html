<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Á¨ë„ÅÜ„Å®„Ç≥„Çπ„É¢„Åä„Åò„Åï„Çì</title>
<style>
  body {
    text-align: center;
    background: #000;
    color: white;
  }
  video, canvas {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }
  #video {
    top: 0;
  }
  #overlay {
    top: 0;
  }
</style>
</head>
<body>
<h1>Á¨ë„ÅÜ„Å®„Ç≥„Çπ„É¢„Åä„Åò„Åï„Çì</h1>
<video id="video" width="640" height="480" autoplay muted></video>
<canvas id="overlay" width="640" height="480"></canvas>

<script src="https://unpkg.com/face-api.js"></script>
<script>
(async function() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  // 1. „Ç´„É°„É©Ëµ∑Âãï
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    console.log("‚úÖ „Ç´„É°„É©Ëµ∑ÂãïÊàêÂäü");
  } catch (err) {
    console.error("‚ùå „Ç´„É°„É©Ëµ∑ÂãïÂ§±Êïó:", err);
    alert("„Ç´„É°„É©„Åå‰Ωø„Åà„Åæ„Åõ„Çì");
    return;
  }

  // „É¢„Éá„É´Ë™≠„ÅøËæº„Åø
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://unpkg.com/face-api.js/models');
  await faceapi.nets.faceExpressionNet.loadFromUri('https://unpkg.com/face-api.js/models');
  console.log("‚úÖ „É¢„Éá„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü");

  // „Ç≥„Çπ„É¢„Åä„Åò„Åï„ÇìÁîªÂÉè
  const ojisanImg = new Image();
  ojisanImg.src = 'ojisan.png'; // Âêå„Åò„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁΩÆ„Åè

  video.addEventListener('play', () => {
    console.log("‚ñ∂ È°îÊ§úÂá∫ÈñãÂßã");
    const detectLoop = async () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

      if (detection) {
        const box = detection.detection.box;
        const expressions = detection.expressions;
        const smileScore = expressions.happy || 0;
        console.log("üòä Á¨ëÈ°î„Çπ„Ç≥„Ç¢:", smileScore.toFixed(2));

        if (smileScore > 0.6) {
          ctx.drawImage(ojisanImg, box.x - 50, box.y - 50, box.width + 100, box.height + 100);
        }
      }
      requestAnimationFrame(detectLoop);
    };
    detectLoop();
  });
})();
</script>
</body>
</html>
